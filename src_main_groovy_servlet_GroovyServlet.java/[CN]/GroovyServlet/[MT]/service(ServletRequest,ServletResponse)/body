{
  final HttpServletRequest httpRequest=(HttpServletRequest)request;
  final HttpServletResponse httpResponse=(HttpServletResponse)response;
  final String scriptFilename=getGroovyScriptPath(httpRequest);
  response.setContentType("text/html");
  final Binding binding=new ServletBinding((HttpServletRequest)request,(HttpServletResponse)response,sc);
  try {
    Closure closure=new Closure(gse){
      public Object call(){
        try {
          return ((GroovyScriptEngine)getDelegate()).run(scriptFilename,binding);
        }
 catch (        ResourceException e) {
          throw new RuntimeException(e);
        }
catch (        ScriptException e) {
          throw new RuntimeException(e);
        }
      }
    }
;
    GroovyCategorySupport.use(ServletCategory.class,closure);
  }
 catch (  RuntimeException re) {
    StringBuffer error=new StringBuffer("GroovyServlet Error: ");
    error.append(" script: '");
    error.append(scriptFilename);
    error.append("': ");
    Throwable e=re.getCause();
    if (e instanceof ResourceException) {
      error.append(" Script not found, sending 404.");
      sc.log(error.toString());
      System.out.println(error.toString());
      httpResponse.sendError(HttpServletResponse.SC_NOT_FOUND);
    }
 else {
      if (re.getMessage() != null)       error.append(re.getMessage());
      if (e != null) {
        sc.log("An error occurred processing the request",e);
      }
 else {
        sc.log("An error occurred processing the request",re);
      }
      sc.log(error.toString());
      System.out.println(error.toString());
      httpResponse.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
    }
  }
}
