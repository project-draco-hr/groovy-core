{
  final String scriptUri=getScriptUri(request);
  response.setContentType("text/html");
  final Binding binding=new ServletBinding(request,response,servletContext);
  try {
    Closure closure=new Closure(gse){
      public Object call(){
        try {
          return ((GroovyScriptEngine)getDelegate()).run(scriptUri,binding);
        }
 catch (        ResourceException e) {
          throw new RuntimeException(e);
        }
catch (        ScriptException e) {
          throw new RuntimeException(e);
        }
      }
    }
;
    GroovyCategorySupport.use(ServletCategory.class,closure);
    response.setStatus(HttpServletResponse.SC_OK);
    response.flushBuffer();
  }
 catch (  RuntimeException re) {
    StringBuffer error=new StringBuffer("GroovyServlet Error: ");
    error.append(" script: '");
    error.append(scriptUri);
    error.append("': ");
    Throwable e=re.getCause();
    if (e instanceof ResourceException) {
      error.append(" Script not found, sending 404.");
      servletContext.log(error.toString());
      System.out.println(error.toString());
      response.sendError(HttpServletResponse.SC_NOT_FOUND);
    }
 else {
      if (re.getMessage() != null)       error.append(re.getMessage());
      if (e != null) {
        servletContext.log("An error occurred processing the request",e);
      }
 else {
        servletContext.log("An error occurred processing the request",re);
      }
      servletContext.log(error.toString());
      System.out.println(error.toString());
      response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,e.toString());
    }
  }
}
