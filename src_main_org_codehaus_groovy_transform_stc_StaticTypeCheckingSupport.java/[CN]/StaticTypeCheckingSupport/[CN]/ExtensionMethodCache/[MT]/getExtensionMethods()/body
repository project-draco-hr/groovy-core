{
  lock.readLock().lock();
  MetaClassRegistry registry=GroovySystem.getMetaClassRegistry();
  if (registry instanceof MetaClassRegistryImpl) {
    MetaClassRegistryImpl impl=(MetaClassRegistryImpl)registry;
    ExtensionModuleRegistry moduleRegistry=impl.getModuleRegistry();
    if (!modules.equals(moduleRegistry.getModules())) {
      lock.readLock().unlock();
      lock.writeLock().lock();
      try {
        if (!modules.equals(moduleRegistry.getModules())) {
          modules=moduleRegistry.getModules();
          cachedMethods=getDGMMethods(registry);
        }
      }
  finally {
        lock.writeLock().unlock();
        lock.readLock().lock();
      }
    }
  }
  try {
    return Collections.unmodifiableMap(cachedMethods);
  }
  finally {
    lock.readLock().unlock();
  }
}
