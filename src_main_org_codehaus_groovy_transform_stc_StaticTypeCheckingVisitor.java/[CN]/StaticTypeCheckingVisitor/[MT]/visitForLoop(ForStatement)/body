{
  final Map<VariableExpression,ClassNode> varOrigType=new HashMap<VariableExpression,ClassNode>();
  forLoop.getLoopBlock().visit(new VariableExpressionTypeMemoizer(varOrigType));
  Map<VariableExpression,List<ClassNode>> oldTracker=pushAssignmentTracking();
  final ClassNode collectionType=getType(forLoop.getCollectionExpression());
  ClassNode componentType=inferLoopElementType(collectionType);
  forLoopVariableTypes.put(forLoop.getVariable(),componentType);
  if (!checkCompatibleAssignmentTypes(forLoop.getVariableType(),componentType)) {
    addStaticTypeError("Cannot loop with element of type " + forLoop.getVariableType() + " with collection of type "+ collectionType,forLoop);
  }
  try {
    super.visitForLoop(forLoop);
  }
  finally {
    forLoopVariableTypes.remove(forLoop.getVariable());
  }
  boolean typeChanged=isSecondPassNeededForControlStructure(varOrigType,oldTracker);
  if (typeChanged)   visitForLoop(forLoop);
}
