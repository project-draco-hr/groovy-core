{
  String basePath=servletContext.getRealPath(".");
  if (name.startsWith(basePath))   name=name.substring(basePath.length());
  String baseVirtualPath=null;
  try {
    URL baseVirtualURL=servletContext.getResource("/");
    if (baseVirtualURL != null) {
      baseVirtualPath=baseVirtualURL.getPath();
      if (name.startsWith(baseVirtualPath))       name=name.substring(baseVirtualPath.length());
    }
  }
 catch (  MalformedURLException e1) {
  }
  Matcher matcher=resourceNameMatcher;
  if (matcher != null) {
    matcher.reset(name);
    String replaced;
    if (resourceNameReplaceAll) {
      replaced=resourceNameMatcher.replaceAll(resourceNameReplacement);
    }
 else {
      replaced=resourceNameMatcher.replaceFirst(resourceNameReplacement);
    }
    if (!name.equals(replaced)) {
      if (verbose) {
        log("Replaced resource name \"" + name + "\" with \""+ replaced+ "\".");
      }
      name=replaced;
    }
  }
  try {
    URL url=servletContext.getResource("/" + name);
    if (url == null) {
      url=servletContext.getResource("/WEB-INF/groovy/" + name);
    }
    if (url == null) {
      throw new ResourceException("Resource \"" + name + "\" not found!");
    }
    return url.openConnection();
  }
 catch (  IOException e) {
    throw new ResourceException("Problems getting resource named \"" + name + "\"!",e);
  }
}
