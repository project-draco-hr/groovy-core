{
  validate(codeSource);
  Class answer;
  CompilationUnit unit=createCompilationUnit(config,codeSource.getCodeSource());
  SourceUnit su=null;
  if (codeSource.getFile() == null) {
    su=unit.addSource(codeSource.getName(),codeSource.getScriptText());
  }
 else {
    su=unit.addSource(codeSource.getFile());
  }
  ClassCollector collector=createCollector(unit,su);
  unit.setClassgenCallback(collector);
  int goalPhase=Phases.CLASS_GENERATION;
  if (config != null && config.getTargetDirectory() != null)   goalPhase=Phases.OUTPUT;
  unit.compile(goalPhase);
  answer=collector.generatedClass;
  String mainClass=su.getAST().getMainClassName();
  for (  Object o : collector.getLoadedClasses()) {
    Class clazz=(Class)o;
    String clazzName=clazz.getName();
    definePackage(clazzName);
    setClassCacheEntry(clazz);
    if (clazzName.equals(mainClass))     answer=clazz;
  }
  return answer;
}
