{
  this.classNode=node;
  if ((classNode.getModifiers() & Opcodes.ACC_INTERFACE) > 0) {
    ConstructorNode dummy=new ConstructorNode(0,null);
    addInitialization(node,dummy);
    node.visitContents(this);
    return;
  }
  ClassNode[] classNodes=classNode.getInterfaces();
  List interfaces=new ArrayList();
  for (int i=0; i < classNodes.length; i++) {
    ClassNode classNode=classNodes[i];
    interfaces.add(classNode.getName());
  }
  Set interfaceSet=new HashSet(interfaces);
  if (interfaceSet.size() != interfaces.size()) {
    throw new RuntimeParserException("Duplicate interfaces in implements list: " + interfaces,classNode);
  }
  addDefaultParameterMethods(node);
  addDefaultParameterConstructors(node);
  String _myClassFieldName="$myClass";
  while (node.getField(_myClassFieldName) != null)   _myClassFieldName=_myClassFieldName + "$";
  final String myClassFieldName=_myClassFieldName;
  final String classInternalName=BytecodeHelper.getClassInternalName(node);
  FieldNode myClassField=node.addField(myClassFieldName,ACC_PRIVATE | ACC_STATIC,ClassHelper.CLASS_Type,new ClassExpression(node));
  myClassField.setSynthetic(true);
  String _staticMetaClassFieldName="$staticMetaClass";
  while (node.getField(_staticMetaClassFieldName) != null)   _staticMetaClassFieldName=_staticMetaClassFieldName + "$";
  final String staticMetaClassFieldName=_staticMetaClassFieldName;
  FieldNode staticMetaClassField=node.addField(staticMetaClassFieldName,ACC_PUBLIC | ACC_STATIC,ClassHelper.make(MetaClass.class),null);
  staticMetaClassField.setSynthetic(true);
  List getStaticMetaClassCode=new LinkedList();
  getStaticMetaClassCode.add(new BytecodeInstruction(){
    public void visit(    MethodVisitor mv){
      mv.visitVarInsn(ALOAD,0);
      mv.visitMethodInsn(INVOKEVIRTUAL,"java/lang/Object","getClass","()Ljava/lang/Class;");
      mv.visitVarInsn(ASTORE,1);
      mv.visitVarInsn(ALOAD,1);
      mv.visitFieldInsn(GETSTATIC,classInternalName,myClassFieldName,"Ljava/lang/Class;");
      Label l0=new Label();
      mv.visitJumpInsn(IF_ACMPNE,l0);
      mv.visitFieldInsn(GETSTATIC,classInternalName,staticMetaClassFieldName,"Lgroovy/lang/MetaClass;");
      Label l1=new Label();
      mv.visitJumpInsn(IFNONNULL,l1);
      mv.visitVarInsn(ALOAD,0);
      mv.visitMethodInsn(INVOKESTATIC,"org/codehaus/groovy/runtime/InvokerHelper","getMetaClass","(Ljava/lang/Object;)Lgroovy/lang/MetaClass;");
      mv.visitFieldInsn(PUTSTATIC,classInternalName,staticMetaClassFieldName,"Lgroovy/lang/MetaClass;");
      mv.visitLabel(l1);
      mv.visitFieldInsn(GETSTATIC,classInternalName,staticMetaClassFieldName,"Lgroovy/lang/MetaClass;");
      mv.visitInsn(ARETURN);
      mv.visitLabel(l0);
      mv.visitVarInsn(ALOAD,1);
      mv.visitMethodInsn(INVOKESTATIC,"org/codehaus/groovy/runtime/InvokerHelper","getMetaClass","(Ljava/lang/Class;)Lgroovy/lang/MetaClass;");
      mv.visitInsn(ARETURN);
    }
  }
);
  node.addSyntheticMethod("$getStaticMetaClass",ACC_PROTECTED,ClassHelper.make(MetaClass.class),Parameter.EMPTY_ARRAY,ClassNode.EMPTY_ARRAY,new BytecodeSequence(getStaticMetaClassCode));
  if (!node.isDerivedFromGroovyObject()) {
    node.addInterface(ClassHelper.make(GroovyObject.class));
    PropertyNode metaClassProperty=node.addProperty("metaClass",ACC_PUBLIC,ClassHelper.METACLASS_TYPE,new BytecodeExpression(){
      public void visit(      MethodVisitor mv){
        mv.visitVarInsn(ALOAD,0);
        mv.visitInsn(DUP);
        mv.visitMethodInsn(INVOKEVIRTUAL,classInternalName,"$getStaticMetaClass","()Lgroovy/lang/MetaClass;");
        mv.visitFieldInsn(PUTFIELD,classInternalName,"metaClass","Lgroovy/lang/MetaClass;");
        mv.visitVarInsn(ALOAD,0);
        mv.visitFieldInsn(GETFIELD,classInternalName,"metaClass","Lgroovy/lang/MetaClass;");
      }
      public ClassNode getType(){
        return ClassHelper.METACLASS_TYPE;
      }
    }
,null,null);
    metaClassProperty.setSynthetic(true);
    FieldNode metaClassField=metaClassProperty.getField();
    metaClassField.setModifiers(metaClassField.getModifiers() | ACC_TRANSIENT);
    List getMetaClassCode=new LinkedList();
    getMetaClassCode.add(new BytecodeInstruction(){
      public void visit(      MethodVisitor mv){
        Label nullLabel=new Label();
        mv.visitVarInsn(ALOAD,0);
        mv.visitFieldInsn(GETFIELD,classInternalName,"metaClass","Lgroovy/lang/MetaClass;");
        mv.visitInsn(DUP);
        mv.visitJumpInsn(IFNULL,nullLabel);
        mv.visitInsn(ARETURN);
        mv.visitLabel(nullLabel);
        mv.visitInsn(POP);
        mv.visitVarInsn(ALOAD,0);
        mv.visitInsn(DUP);
        mv.visitMethodInsn(INVOKEVIRTUAL,classInternalName,"$getStaticMetaClass","()Lgroovy/lang/MetaClass;");
        mv.visitFieldInsn(PUTFIELD,classInternalName,"metaClass","Lgroovy/lang/MetaClass;");
        mv.visitVarInsn(ALOAD,0);
        mv.visitFieldInsn(GETFIELD,classInternalName,"metaClass","Lgroovy/lang/MetaClass;");
        mv.visitInsn(ARETURN);
      }
    }
);
    node.addSyntheticMethod("getMetaClass",ACC_PUBLIC,ClassHelper.make(MetaClass.class),Parameter.EMPTY_ARRAY,ClassNode.EMPTY_ARRAY,new BytecodeSequence(getMetaClassCode));
    ClassNode superClass=node.getSuperClass();
    boolean addDelegateObject=(node instanceof InnerClassNode && superClass.equals(ClassHelper.CLOSURE_TYPE)) || superClass.equals(ClassHelper.GSTRING_TYPE);
    if (!addDelegateObject) {
      List invokeMethodCode=new LinkedList();
      invokeMethodCode.add(new BytecodeInstruction(){
        public void visit(        MethodVisitor mv){
          mv.visitVarInsn(ALOAD,0);
          mv.visitMethodInsn(INVOKEVIRTUAL,classInternalName,"getMetaClass","()Lgroovy/lang/MetaClass;");
          mv.visitVarInsn(ALOAD,0);
          mv.visitVarInsn(ALOAD,1);
          mv.visitVarInsn(ALOAD,2);
          mv.visitMethodInsn(INVOKEINTERFACE,"groovy/lang/MetaObjectProtocol","invokeMethod","(Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;");
          mv.visitInsn(ARETURN);
        }
      }
);
      node.addSyntheticMethod("invokeMethod",ACC_PUBLIC,ClassHelper.OBJECT_TYPE,new Parameter[]{new Parameter(ClassHelper.STRING_TYPE,"method"),new Parameter(ClassHelper.OBJECT_TYPE,"arguments")},ClassNode.EMPTY_ARRAY,new BytecodeSequence(invokeMethodCode));
      if (!node.isScript()) {
        List getPropertyCode=new LinkedList();
        getPropertyCode.add(new BytecodeInstruction(){
          public void visit(          MethodVisitor mv){
            mv.visitVarInsn(ALOAD,0);
            mv.visitMethodInsn(INVOKEVIRTUAL,classInternalName,"getMetaClass","()Lgroovy/lang/MetaClass;");
            mv.visitVarInsn(ALOAD,0);
            mv.visitVarInsn(ALOAD,1);
            mv.visitMethodInsn(INVOKEINTERFACE,"groovy/lang/MetaClass","getProperty","(Ljava/lang/Object;Ljava/lang/String;)Ljava/lang/Object;");
            mv.visitInsn(ARETURN);
          }
        }
);
        node.addSyntheticMethod("getProperty",ACC_PUBLIC,ClassHelper.OBJECT_TYPE,new Parameter[]{new Parameter(ClassHelper.STRING_TYPE,"property")},ClassNode.EMPTY_ARRAY,new BytecodeSequence(getPropertyCode));
        List setPropertyCode=new LinkedList();
        setPropertyCode.add(new BytecodeInstruction(){
          public void visit(          MethodVisitor mv){
            mv.visitVarInsn(ALOAD,0);
            mv.visitMethodInsn(INVOKEVIRTUAL,classInternalName,"getMetaClass","()Lgroovy/lang/MetaClass;");
            mv.visitVarInsn(ALOAD,0);
            mv.visitVarInsn(ALOAD,1);
            mv.visitVarInsn(ALOAD,2);
            mv.visitMethodInsn(INVOKEINTERFACE,"groovy/lang/MetaClass","setProperty","(Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)V");
            mv.visitInsn(RETURN);
          }
        }
);
        node.addSyntheticMethod("setProperty",ACC_PUBLIC,ClassHelper.VOID_TYPE,new Parameter[]{new Parameter(ClassHelper.STRING_TYPE,"property"),new Parameter(ClassHelper.OBJECT_TYPE,"value")},ClassNode.EMPTY_ARRAY,new BytecodeSequence(setPropertyCode));
      }
    }
  }
  if (node.getDeclaredConstructors().isEmpty()) {
    ConstructorNode constructor=new ConstructorNode(ACC_PUBLIC,null);
    constructor.setSynthetic(true);
    node.addConstructor(constructor);
  }
  if (!(node instanceof InnerClassNode)) {
    addTimeStamp(node);
  }
  addInitialization(node);
  checkReturnInObjectInitializer(node.getObjectInitializerStatements());
  node.getObjectInitializerStatements().clear();
  addCovariantMethods(node);
  node.visitContents(this);
}
