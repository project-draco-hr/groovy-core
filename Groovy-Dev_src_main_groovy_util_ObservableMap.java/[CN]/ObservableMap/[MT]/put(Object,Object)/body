{
  Object oldValue=null;
  boolean newKey=!delegate.containsKey(key);
  if (test != null) {
    oldValue=delegate.put(key,value);
    Object result=null;
    if (test.getMaximumNumberOfParameters() == 2) {
      result=test.call(new Object[]{key,value});
    }
 else {
      result=test.call(value);
    }
    if (result != null && result instanceof Boolean && ((Boolean)result).booleanValue()) {
      if (newKey) {
        pcs.firePropertyChange(new PropertyAddedEvent(this,String.valueOf(key),value));
      }
 else       if (oldValue != value) {
        pcs.firePropertyChange(new PropertyUpdatedEvent(this,String.valueOf(key),oldValue,value));
      }
    }
  }
 else {
    oldValue=delegate.put(key,value);
    if (newKey) {
      pcs.firePropertyChange(new PropertyAddedEvent(this,String.valueOf(key),value));
    }
 else     if (oldValue != value) {
      pcs.firePropertyChange(new PropertyUpdatedEvent(this,String.valueOf(key),oldValue,value));
    }
  }
  return oldValue;
}
