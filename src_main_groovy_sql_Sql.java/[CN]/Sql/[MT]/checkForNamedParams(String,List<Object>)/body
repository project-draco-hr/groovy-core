{
  if (!NAMED_QUERY_PATTERN.matcher(sql).find()) {
    return new SqlWithParams(sql,params);
  }
  List<Object> updatedParams=new ArrayList<Object>();
  StringBuilder sb=new StringBuilder();
  StringBuilder currentChunk=new StringBuilder();
  char[] chars=sql.toCharArray();
  int i=0;
  boolean inString=false;
  while (i < chars.length) {
switch (chars[i]) {
case '\'':
      inString=!inString;
    if (inString) {
      sb.append(adaptForNamedParams(currentChunk.toString(),params,updatedParams));
      currentChunk=new StringBuilder();
      currentChunk.append(chars[i]);
    }
 else {
      currentChunk.append(chars[i]);
      sb.append(currentChunk);
      currentChunk=new StringBuilder();
    }
  break;
default :
currentChunk.append(chars[i]);
}
i++;
}
if (inString) throw new IllegalStateException("Failed to process query. Unterminated ' character?");
sb.append(adaptForNamedParams(currentChunk.toString(),params,updatedParams));
String newSql=sb.toString();
if (sql.equals(newSql)) {
return new SqlWithParams(sql,params);
}
 else {
LOG.fine(newSql + " | " + updatedParams);
}
return new SqlWithParams(newSql,updatedParams);
}
