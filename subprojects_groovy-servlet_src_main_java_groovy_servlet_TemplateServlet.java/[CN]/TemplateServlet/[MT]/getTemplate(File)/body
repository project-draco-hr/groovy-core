{
  String key=file.getAbsolutePath();
  Template template=null;
  if (verbose) {
    log("Looking for cached template by key \"" + key + "\"");
  }
  TemplateCacheEntry entry=(TemplateCacheEntry)cache.get(key);
  if (entry != null) {
    if (entry.validate(file)) {
      if (verbose) {
        log("Cache hit! " + entry);
      }
      template=entry.template;
    }
 else {
      if (verbose) {
        log("Cached template needs recompilation!");
      }
    }
  }
 else {
    if (verbose) {
      log("Cache miss.");
    }
  }
  if (template == null) {
    if (verbose) {
      log("Creating new template from file " + file + "...");
    }
    String fileEncoding=(fileEncodingParamVal != null) ? fileEncodingParamVal : System.getProperty(GROOVY_SOURCE_ENCODING);
    Reader reader=null;
    try {
      reader=fileEncoding == null ? new FileReader(file) : new InputStreamReader(new FileInputStream(file),fileEncoding);
      template=engine.createTemplate(reader);
    }
 catch (    Exception e) {
      throw new ServletException("Creation of template failed: " + e,e);
    }
 finally {
      if (reader != null) {
        try {
          reader.close();
        }
 catch (        IOException ignore) {
        }
      }
    }
    cache.put(key,new TemplateCacheEntry(file,template,verbose));
    if (verbose) {
      log("Created and added template to cache. [key=" + key + "]");
    }
  }
  if (template == null) {
    throw new ServletException("Template is null? Should not happen here!");
  }
  return template;
}
