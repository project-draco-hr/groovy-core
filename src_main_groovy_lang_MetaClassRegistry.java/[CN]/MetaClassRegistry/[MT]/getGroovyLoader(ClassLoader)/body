{
  if (loader instanceof GroovyClassLoader) {
    return (GroovyClassLoader)loader;
  }
synchronized (loaderMap) {
    GroovyClassLoader groovyLoader=(GroovyClassLoader)loaderMap.get(loader);
    if (groovyLoader == null) {
      if (loader == null || loader == getClass().getClassLoader()) {
        groovyLoader=this.loader;
      }
 else {
        try {
          loader.loadClass(getClass().getName());
          groovyLoader=new GroovyClassLoader(loader);
        }
 catch (        ClassNotFoundException e) {
          final ClassLoader localLoader=getClass().getClassLoader();
          groovyLoader=(GroovyClassLoader)AccessController.doPrivileged(new PrivilegedAction(){
            public Object run(){
              return new GroovyClassLoader(localLoader);
            }
          }
);
        }
      }
      loaderMap.put(loader,groovyLoader);
    }
    return groovyLoader;
  }
}
