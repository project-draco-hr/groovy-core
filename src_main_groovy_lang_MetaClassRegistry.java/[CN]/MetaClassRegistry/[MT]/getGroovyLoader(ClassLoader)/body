{
  if (loader instanceof GroovyClassLoader) {
    return (GroovyClassLoader)loader;
  }
synchronized (loaderMap) {
    GroovyClassLoader groovyLoader=(GroovyClassLoader)loaderMap.get(loader);
    if (groovyLoader == null) {
      if (loader == null || loader == getClass().getClassLoader()) {
        groovyLoader=this.loader;
      }
 else {
        ClassLoader localLoader=getClass().getClassLoader();
        ClassLoader parent=loader;
        while (parent != localLoader && parent != null)         parent=parent.getParent();
        if (parent == null) {
          groovyLoader=new GroovyClassLoader(localLoader);
        }
 else {
          groovyLoader=new GroovyClassLoader(loader);
        }
      }
      loaderMap.put(loader,groovyLoader);
    }
    return groovyLoader;
  }
}
