{
  ClassNode owner=classNode;
  boolean parentIsInnerClass=owner instanceof InnerClassNode;
  String outerClassName=owner.getName();
  String name=outerClassName + "$" + context.getNextInnerClassIdx();
  boolean staticMethodOrInStaticClass=isStaticMethod() || classNode.isStaticClass();
  if (staticMethodOrInStaticClass) {
    outerClassName="java.lang.Class";
  }
  Parameter[] parameters=expression.getParameters();
  if (parameters == null || parameters.length == 0) {
    parameters=new Parameter[]{new Parameter("it")};
  }
  Parameter[] localVariableParams=getClosureSharedVariables(expression);
  InnerClassNode answer=new InnerClassNode(owner,name,ACC_PUBLIC,"groovy.lang.Closure");
  if (staticMethodOrInStaticClass) {
    answer.setStaticClass(true);
  }
  if (isInScriptBody()) {
    answer.setScriptBody(true);
  }
  MethodNode method=answer.addMethod("doCall",ACC_PUBLIC,"java.lang.Object",parameters,expression.getCode());
  VariableScope scope=expression.getVariableScope();
  if (scope == null) {
    throw new RuntimeException("Must have a VariableScope by now! for expression: " + expression + " class: "+ name);
  }
 else {
    method.setVariableScope(scope);
  }
  if (parameters.length > 1 || (parameters.length == 1 && parameters[0].getType() != null && !parameters[0].getType().equals("java.lang.Object"))) {
    answer.addMethod("call",ACC_PUBLIC,"java.lang.Object",parameters,new ReturnStatement(new MethodCallExpression(VariableExpression.THIS_EXPRESSION,"doCall",new ArgumentListExpression(parameters))));
  }
  FieldNode field=answer.addField("owner",ACC_PRIVATE,outerClassName,null);
  BlockStatement block=new BlockStatement();
  block.addStatement(new ExpressionStatement(new MethodCallExpression(new VariableExpression("super"),"<init>",new VariableExpression("_outerInstance"))));
  block.addStatement(new ExpressionStatement(new BinaryExpression(new FieldExpression(field),Token.equal(-1,-1),new VariableExpression("_outerInstance"))));
  for (int i=0; i < localVariableParams.length; i++) {
    Parameter param=localVariableParams[i];
    String paramName=param.getName();
    boolean holder=mutableVars.contains(paramName);
    Expression initialValue=null;
    String type=param.getType();
    if (holder) {
      initialValue=new VariableExpression(paramName);
      type=Reference.class.getName();
      param.makeReference();
    }
    FieldNode paramField=null;
    if (holder) {
      paramField=answer.addField(paramName,ACC_PRIVATE,type,initialValue);
      paramField.setHolder(true);
      String realType=param.getRealType();
      String methodName=Verifier.capitalize(paramName);
      Expression fieldExp=new FieldExpression(paramField);
      answer.addMethod("get" + methodName,ACC_PUBLIC,realType,Parameter.EMPTY_ARRAY,new ReturnStatement(fieldExp));
    }
 else {
      PropertyNode propertyNode=answer.addProperty(paramName,ACC_PUBLIC,type,initialValue,null,null);
      paramField=propertyNode.getField();
    }
    if (!holder) {
      block.addStatement(new ExpressionStatement(new BinaryExpression(new FieldExpression(paramField),Token.equal(-1,-1),new VariableExpression(paramName))));
    }
  }
  Parameter[] params=new Parameter[2 + localVariableParams.length];
  params[0]=new Parameter(outerClassName,"_outerInstance");
  params[1]=new Parameter("java.lang.Object","_delegate");
  System.arraycopy(localVariableParams,0,params,2,localVariableParams.length);
  answer.addConstructor(ACC_PUBLIC,params,block);
  return answer;
}
