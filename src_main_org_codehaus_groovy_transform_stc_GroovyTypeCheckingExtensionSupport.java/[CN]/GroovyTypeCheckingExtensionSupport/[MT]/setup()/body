{
  CompilerConfiguration config=new CompilerConfiguration();
  config.setScriptBaseClass("org.codehaus.groovy.transform.stc.GroovyTypeCheckingExtensionSupport.TypeCheckingDSL");
  ImportCustomizer ic=new ImportCustomizer();
  ic.addStarImports("org.codehaus.groovy.ast.expr");
  ic.addStaticStars("org.codehaus.groovy.ast.ClassHelper");
  ic.addStaticStars("org.codehaus.groovy.transform.stc.StaticTypeCheckingSupport");
  config.addCompilationCustomizers(ic);
  ClassLoader cl=typeCheckingVisitor.getSourceUnit().getClassLoader();
  List<String> classpath=new LinkedList<String>();
  while (cl instanceof URLClassLoader) {
    URLClassLoader gcl=(URLClassLoader)cl;
    for (    URL url : gcl.getURLs()) {
      try {
        classpath.add(new File(url.toURI()).getCanonicalPath());
      }
 catch (      IOException e) {
      }
catch (      URISyntaxException e) {
      }
    }
    cl=cl.getParent();
  }
  cl=typeCheckingVisitor.getSourceUnit().getClassLoader();
  config.setClasspathList(classpath);
  InputStream is=cl.getResourceAsStream(scriptPath);
  if (is == null) {
    cl=GroovyTypeCheckingExtensionSupport.class.getClassLoader();
    is=cl.getResourceAsStream(scriptPath);
  }
  if (is == null) {
    context.getErrorCollector().addFatalError(new SimpleMessage("Static type checking extension '" + scriptPath + "' was not found on the classpath.",config.getDebug(),typeCheckingVisitor.getSourceUnit()));
  }
  try {
    GroovyShell shell=new GroovyShell(config);
    TypeCheckingDSL parse=(TypeCheckingDSL)shell.parse(new InputStreamReader(is,typeCheckingVisitor.getSourceUnit().getConfiguration().getSourceEncoding()));
    parse.extension=this;
    parse.run();
    List<Closure> list=eventHandlers.get("setup");
    if (list != null) {
      for (      Closure closure : list) {
        safeCall(closure);
      }
    }
  }
 catch (  CompilationFailedException e) {
    throw new GroovyBugError("An unexpected error was thrown during custom type checking",e);
  }
catch (  UnsupportedEncodingException e) {
    throw new GroovyBugError("Unsupported encoding found in compiler configuration",e);
  }
}
