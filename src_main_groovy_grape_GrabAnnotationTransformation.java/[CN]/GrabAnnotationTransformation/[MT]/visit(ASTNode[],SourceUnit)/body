{
  sourceUnit=source;
  loader=null;
  initContextClassLoader=false;
  ModuleNode mn=(ModuleNode)nodes[0];
  allowShortGrab=true;
  allowShortGrabExcludes=true;
  allowShortGrabConfig=true;
  allowShortGrapes=true;
  grabAliases=new HashSet<String>();
  grabExcludeAliases=new HashSet<String>();
  grabConfigAliases=new HashSet<String>();
  grapesAliases=new HashSet<String>();
  for (  ImportNode im : mn.getImports()) {
    String alias=im.getAlias();
    String className=im.getClassName();
    if ((className.endsWith(GRAB_DOT_NAME) && ((alias == null) || (alias.length() == 0))) || (GRAB_CLASS_NAME.equals(alias))) {
      allowShortGrab=false;
    }
 else     if (GRAB_CLASS_NAME.equals(className)) {
      grabAliases.add(im.getAlias());
    }
    if ((className.endsWith(GRAPES_DOT_NAME) && ((alias == null) || (alias.length() == 0))) || (GRAPES_CLASS_NAME.equals(alias))) {
      allowShortGrapes=false;
    }
 else     if (GRAPES_CLASS_NAME.equals(className)) {
      grapesAliases.add(im.getAlias());
    }
  }
  List<Map<String,Object>> grabMaps=new ArrayList<Map<String,Object>>();
  List<Map<String,Object>> grabExcludeMaps=new ArrayList<Map<String,Object>>();
  for (  ClassNode classNode : sourceUnit.getAST().getClasses()) {
    grabAnnotations=new ArrayList<AnnotationNode>();
    grabExcludeAnnotations=new ArrayList<AnnotationNode>();
    grabConfigAnnotations=new ArrayList<AnnotationNode>();
    grapesAnnotations=new ArrayList<AnnotationNode>();
    visitClass(classNode);
    ClassNode grapeClassNode=new ClassNode(Grape.class);
    if (!grapesAnnotations.isEmpty()) {
      for (      AnnotationNode node : grapesAnnotations) {
        Expression init=node.getMember("initClass");
        Expression value=node.getMember("value");
        if (value instanceof ListExpression) {
          for (          Object o : ((ListExpression)value).getExpressions()) {
            if (o instanceof ConstantExpression) {
              extractGrab(init,(ConstantExpression)o);
            }
          }
        }
 else         if (value instanceof ConstantExpression) {
          extractGrab(init,(ConstantExpression)value);
        }
      }
    }
    if (!grabConfigAnnotations.isEmpty()) {
      for (      AnnotationNode node : grabConfigAnnotations) {
        checkForClassLoader(node);
        checkForInitContextClassLoader(node);
      }
      addInitContextClassLoaderIfNeeded(classNode);
    }
    if (!grabExcludeAnnotations.isEmpty()) {
      grabExcludeAnnotationLoop:       for (      AnnotationNode node : grabExcludeAnnotations) {
        Map<String,Object> grabExcludeMap=new HashMap<String,Object>();
        checkForConvenienceForm(node);
        for (        String s : GRABEXCLUDE_REQUIRED) {
          Expression member=node.getMember(s);
          if (member == null) {
            addError("The missing attribute \"" + s + "\" is required in @"+ node.getClassNode().getNameWithoutPackage()+ " annotations",node);
            continue grabExcludeAnnotationLoop;
          }
 else           if (member != null && !(member instanceof ConstantExpression)) {
            addError("Attribute \"" + s + "\" has value "+ member.getText()+ " but should be an inline constant in @"+ node.getClassNode().getNameWithoutPackage()+ " annotations",node);
            continue grabExcludeAnnotationLoop;
          }
          grabExcludeMap.put(s,((ConstantExpression)member).getValue());
        }
        grabExcludeMaps.add(grabExcludeMap);
      }
    }
    if (!grabAnnotations.isEmpty()) {
      grabAnnotationLoop:       for (      AnnotationNode node : grabAnnotations) {
        Map<String,Object> grabMap=new HashMap<String,Object>();
        checkForConvenienceForm(node);
        for (        String s : GRAB_ALL) {
          Expression member=node.getMember(s);
          if (member == null && !GRAB_OPTIONAL.contains(s)) {
            addError("The missing attribute \"" + s + "\" is required in @"+ node.getClassNode().getNameWithoutPackage()+ " annotations",node);
            continue grabAnnotationLoop;
          }
 else           if (member != null && !(member instanceof ConstantExpression)) {
            addError("Attribute \"" + s + "\" has value "+ member.getText()+ " but should be an inline constant in @"+ node.getClassNode().getNameWithoutPackage()+ " annotations",node);
            continue grabAnnotationLoop;
          }
          if (node.getMember(s) != null)           grabMap.put(s,((ConstantExpression)member).getValue());
        }
        grabMaps.add(grabMap);
        callGrabAsStaticInitIfNeeded(classNode,grapeClassNode,node,grabExcludeMaps);
      }
    }
  }
  if (!grabMaps.isEmpty()) {
    Map<String,Object> basicArgs=new HashMap<String,Object>();
    basicArgs.put("classLoader",loader != null ? loader : sourceUnit.getClassLoader());
    if (!grabExcludeMaps.isEmpty())     basicArgs.put("excludes",grabExcludeMaps);
    try {
      Grape.grab(basicArgs,grabMaps.toArray(new Map[grabMaps.size()]));
    }
 catch (    RuntimeException re) {
      source.addException(re);
    }
  }
}
