{
  int size=stack.size();
  try {
    if (size == 0) {
      StringBuilder sb=new StringBuilder();
      sb.append("Internal compiler error while compiling ").append(controller.getSourceUnit().getName()).append("\n");
      MethodNode methodNode=controller.getMethodNode();
      if (methodNode != null) {
        sb.append("Method: ");
        sb.append(methodNode);
        sb.append("\n");
      }
      ConstructorNode constructorNode=controller.getConstructorNode();
      if (constructorNode != null) {
        sb.append("Constructor: ");
        sb.append(methodNode);
        sb.append("\n");
      }
      sb.append("Line ").append(controller.getLineNumber()).append(",");
      sb.append(" expecting ").append(coerce ? "coercion" : "casting").append(" to ").append(targetType.toString(false));
      sb.append(" but operand stack is empty");
      throw new ArrayIndexOutOfBoundsException(sb.toString());
    }
  }
 catch (  ArrayIndexOutOfBoundsException ai) {
    throw ai;
  }
  ClassNode top=stack.get(size - 1);
  targetType=targetType.redirect();
  if (targetType == top)   return;
  MethodVisitor mv=controller.getMethodVisitor();
  if (coerce) {
    if (top.isDerivedFrom(targetType))     return;
    box();
    (new ClassExpression(targetType)).visit(controller.getAcg());
    remove(1);
    asTypeMethod.call(mv);
    BytecodeHelper.doCast(mv,targetType);
    replace(targetType);
    return;
  }
  boolean primTarget=ClassHelper.isPrimitiveType(targetType);
  boolean primTop=ClassHelper.isPrimitiveType(top);
  if (primTop && primTarget) {
    if (convertPrimitive(top,targetType)) {
      replace(targetType);
      return;
    }
    box();
  }
 else   if (primTop) {
    ClassNode boxedType=box();
    castToTypeIfNecessary(boxedType,targetType);
  }
 else   if (primTarget) {
  }
 else {
    castToTypeIfNecessary(top,targetType);
  }
  if (ClassHelper.isNumberType(top) && primTarget && ClassHelper.isNumberType(targetType)) {
    BytecodeHelper.doCastToPrimitive(mv,top,targetType);
  }
 else {
    top=stack.get(size - 1);
    if (!implementsInterfaceOrSubclassOf(top,targetType)) {
      BytecodeHelper.doCast(mv,targetType);
    }
  }
  replace(targetType);
}
