{
  if (value == null)   throw new IllegalArgumentException();
  StringBuilder sb=null;
  for (int i=0, len=value.length(); i < len; i++) {
    final char ch=value.charAt(i);
    final String replacement=checkForReplacement(isAttrValue,ch);
    if (replacement != null) {
      if (sb == null) {
        sb=new StringBuilder((int)(1.1 * len));
        sb.append(value.substring(0,i));
      }
      sb.append(replacement);
    }
 else     if (sb != null) {
      sb.append(ch);
    }
  }
  return sb == null ? value : sb.toString();
}
