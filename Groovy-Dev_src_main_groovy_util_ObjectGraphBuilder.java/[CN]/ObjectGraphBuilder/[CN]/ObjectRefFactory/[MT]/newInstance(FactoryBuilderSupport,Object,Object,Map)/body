{
  ObjectGraphBuilder ogbuilder=(ObjectGraphBuilder)builder;
  String refProperty=ogbuilder.referenceResolver.getReferenceFor((String)name);
  String refId=(String)properties.remove(refProperty);
  Object object=ogbuilder.getProperty(refId);
  if (object == null) {
    throw new IllegalArgumentException("There is no previous node with " + ogbuilder.identifierResolver.getIdentifierFor((String)name) + "="+ refId);
  }
  if (!properties.isEmpty()) {
    throw new IllegalArgumentException("You can not modify the properties of a referenced object.");
  }
  Map context=ogbuilder.getContext();
  context.put(ObjectGraphBuilder.NODE_NAME,name);
  context.put(ObjectGraphBuilder.NODE_CLASS,object.getClass());
  return object;
}
