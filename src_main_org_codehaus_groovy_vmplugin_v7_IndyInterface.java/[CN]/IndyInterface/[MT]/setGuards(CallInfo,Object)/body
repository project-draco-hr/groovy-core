{
  if (ci.handle == null)   return;
  if (ci.spread)   return;
  MethodHandle fallback=makeFallBack(ci.callSite,ci.sender,ci.name,ci.callID,ci.targetType,ci.safeNavigationOrig,ci.thisCall,ci.spread);
  if (receiver instanceof GroovyObject) {
    GroovyObject go=(GroovyObject)receiver;
    MetaClass mc=(MetaClass)go.getMetaClass();
    MethodHandle test=SAME_MC.bindTo(mc);
    test=test.asType(MethodType.methodType(boolean.class,ci.targetType.parameterType(0)));
    ci.handle=MethodHandles.guardWithTest(test,ci.handle,fallback);
    if (LOG_ENABLED)     LOG.info("added meta class equality check");
  }
  if (!ci.useMetaClass) {
    if (ci.method instanceof NewInstanceMetaMethod) {
      ci.handle=MethodHandles.guardWithTest(HAS_CATEGORY_IN_CURRENT_THREAD_GUARD,ci.handle,fallback);
      if (LOG_ENABLED)       LOG.info("added category-in-current-thread-guard for category method");
    }
  }
  ci.handle=switchPoint.guardWithTest(ci.handle,fallback);
  if (LOG_ENABLED)   LOG.info("added switch point guard");
  Class[] pt=ci.handle.type().parameterArray();
  for (int i=0; i < ci.args.length; i++) {
    Object arg=ci.args[i];
    MethodHandle test=null;
    if (arg == null) {
      test=IS_NULL.asType(MethodType.methodType(boolean.class,pt[i]));
      if (LOG_ENABLED)       LOG.info("added null argument check at pos " + i);
    }
 else {
      Class argClass=arg.getClass();
      if (Modifier.isFinal(argClass.getModifiers()) && TypeHelper.argumentClassIsParameterClass(argClass,pt[i]))       continue;
      test=SAME_CLASS.bindTo(argClass).asType(MethodType.methodType(boolean.class,pt[i]));
      if (LOG_ENABLED)       LOG.info("added same class check at pos " + i);
    }
    Class[] drops=new Class[i];
    for (int j=0; j < drops.length; j++)     drops[j]=pt[j];
    test=MethodHandles.dropArguments(test,0,drops);
    ci.handle=MethodHandles.guardWithTest(test,ci.handle,fallback);
  }
}
